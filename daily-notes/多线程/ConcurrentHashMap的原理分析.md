# ConcurrentHashMap的原理

## initTable

数组初始化方法，这个方法比较简单，就是初始化一个合适大小的数组

- sizeCtl 这个标志是在 Node 数组初始化或者扩容的时候的一个控制位标识，负数代表正在进行初始化或者扩容操作
  -1 代表正在初始化
  -N 代表有 N-1 有二个线程正在进行扩容操作，这里不是简单的理解成 n 个线程，sizeCtl 就是-N,这块后续在讲扩容的时候会说明
  0 标识 Node 数组还没有被初始化，正数代表初始化或者下一次扩容的大小


## addCount


- ConcurrentHashMap 是采用 CounterCell 数组来记录元素个数的，像一般的集合记录集合大
  小，直接定义一个 size 的成员变量即可，当出现改变的时候只要更新这个变量就行。为什么
  ConcurrentHashMap 要用这种形式来处理呢？
- 问题还是处在并发上，ConcurrentHashMap 是并发集合，如果用一个成员变量来统计元素个数的话，为了保证并发情况下共享变量的的难全兴，势必会需要通过加锁或者自旋来实现，
  如果竞争比较激烈的情况下，size 的设置上会出现比较大的冲突反而影响了性能，所以在
  ConcurrentHashMap 采用了分片的方法来记录大小
- baseCount: 用来记录元素个数的成员属性
